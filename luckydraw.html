<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUCKY DRAW | ARA BG COMMUNITY</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-silk: #FDF9F3;
            --matcha-leaf: #6B7A68;
            --matcha-dark: #4A5747;
            --clay-text: #4A443F;
            --white-pure: #FFFFFF;
            --gold-leaf: #D4AF37;
            --gold-dim: #C5A028;
            --alert-red: #D65A5A;
            --pebble-shadow: rgba(74, 68, 63, 0.12);
        }

        html { overflow-x: hidden; max-width: 100vw; }
        body {
            margin: 0; padding: 0; width: 100%; max-width: 100vw; overflow-x: hidden;
            background-color: var(--bg-silk);
            background-image: url("https://www.transparenttextures.com/patterns/paper.png");
            background-attachment: fixed;
            color: var(--clay-text);
            font-family: 'Quicksand', sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        nav {
            width: 100%; background: rgba(253, 249, 243, 0.98); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000; padding: 15px 5px;
            border-bottom: 1px solid rgba(107, 122, 104, 0.08);
        }
        .nav-links { display: flex; justify-content: center; gap: clamp(15px, 4vw, 40px); }
        .nav-item {
            color: var(--clay-text); text-decoration: none; font-size: 0.75rem;
            text-transform: uppercase; letter-spacing: 2px; font-weight: 500; opacity: 0.7; transition: 0.3s;
        }
        .nav-item.active { color: var(--matcha-leaf); font-weight: 700; border-bottom: 2px solid var(--gold-leaf); opacity: 1; }

        header { padding: 30px 15px 15px; text-align: center; width: 100%; }
        h1 { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 700; color: var(--matcha-leaf); font-size: clamp(2rem, 5vw, 3.5rem); margin: 0; text-shadow: 2px 2px 0px rgba(0,0,0,0.05); }

        /* --- SETUP --- */
        .setup-container {
            width: 92%; max-width: 1000px; margin: 20px auto;
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 30px var(--pebble-shadow);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;
            transition: all 0.3s ease; border: 1px solid #f0f0f0;
        }
        
        .input-group h3 { margin: 0 0 5px 0; font-family: 'Playfair Display', serif; color: var(--matcha-leaf); display: flex; align-items: center; gap: 8px; }
        .input-group small { display: block; margin-bottom: 8px; font-size: 0.8rem; opacity: 0.7; font-weight: 700; }
        textarea { 
            width: 100%; height: 120px; border: 2px solid #eee; border-radius: 12px; padding: 12px; 
            font-family: inherit; font-size: 0.9rem; transition: 0.3s; resize: vertical;
        }
        textarea:focus { border-color: var(--matcha-leaf); outline: none; background: #fafdfa; }

        .btn-row { grid-column: 1 / -1; display: flex; gap: 10px; }
        .lock-btn { 
            flex: 1; padding: 16px; background: var(--matcha-leaf); color: white; border: none; 
            border-radius: 50px; cursor: pointer; letter-spacing: 2px; font-weight: 700; 
            text-transform: uppercase; transition: 0.2s; box-shadow: 0 5px 15px rgba(107, 122, 104, 0.3);
        }
        .lock-btn:hover { background: var(--matcha-dark); transform: translateY(-2px); }

        /* --- PARTICIPANT DISPLAY BOARD --- */
        .participants-board {
            width: 94%; max-width: 1100px; margin: 0 auto 30px;
            display: none; 
            grid-template-columns: repeat(3, 1fr); gap: 20px;
        }
        .p-column {
            background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 5px 15px var(--pebble-shadow);
            border: 1px solid rgba(0,0,0,0.03);
            max-height: 300px; overflow-y: auto;
        }
        .p-column h4 { margin: 0 0 10px 0; color: var(--matcha-leaf); font-family: 'Playfair Display'; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .p-list { list-style: none; padding: 0; margin: 0; }
        .p-item { 
            padding: 8px 5px; border-bottom: 1px solid #fafafa; font-size: 0.9rem; color: var(--clay-text);
            display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;
        }
        .p-item.won { 
            color: var(--gold-leaf); 
            font-weight: 800; 
            background: rgba(253, 249, 243, 0.5);
            border-radius: 4px;
        }
        .p-item.won::after { content: 'üèÜ'; font-style: normal; text-decoration: none; margin-left: 5px; }

        @media (max-width: 768px) { .participants-board { grid-template-columns: 1fr; } }

        /* --- PRIZE GRID --- */
        .game-section { width: 94%; max-width: 1100px; margin: 10px auto 40px; }
        .pot-title { 
            font-family: 'Playfair Display', serif; color: var(--matcha-leaf); 
            font-size: clamp(1.4rem, 4vw, 2rem); border-bottom: 2px solid var(--gold-leaf); 
            margin-bottom: 25px; padding-bottom: 10px; display: flex; 
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .pot-rules { 
            font-family: 'Quicksand'; font-size: 0.75rem; color: white; 
            background: var(--matcha-leaf); padding: 4px 12px; border-radius: 20px;
            letter-spacing: 1px; text-transform: uppercase; 
        }
        .prizes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; }
        @media (max-width: 1024px) { .prizes-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .prizes-grid { grid-template-columns: 1fr; } }

        .prize-card { 
            position: relative; height: 280px; border-radius: 16px; overflow: hidden; 
            background-color: white; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            box-shadow: 0 5px 15px var(--pebble-shadow); border: 1px solid rgba(0,0,0,0.05); 
        }
        .prize-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        .game-img { width: 100%; height: 100%; object-fit: contain; padding: 20px; background: white; transition: 0.3s; }
        
        .card-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            padding: 15px 15px; text-align: center; border-top: 1px solid rgba(0,0,0,0.05);
        }
        .card-overlay h4 { margin: 0; color: var(--clay-text); font-size: 1.1rem; }
        .winner-display { color: var(--gold-dim); font-weight: 700; font-size: 0.9rem; margin-top: 5px; height: 0; overflow: hidden; transition: 0.3s; opacity: 0; }
        
        .prize-card.drawn { pointer-events: none; border: 2px solid var(--gold-leaf); }
        .prize-card.drawn .game-img { opacity: 0.3; filter: grayscale(1); }
        .prize-card.drawn .winner-display { height: auto; opacity: 1; margin-top: 5px; }
        .prize-card.drawn::after { 
            content: "CLAIMED"; position: absolute; top: 40%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-10deg); 
            font-family: 'Playfair Display'; font-style: italic; font-weight: 900; 
            font-size: 2rem; color: var(--gold-leaf); 
            border: 4px solid var(--gold-leaf); padding: 5px 20px; 
            border-radius: 8px; opacity: 0.8;
        }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(30, 35, 30, 0.95); backdrop-filter: blur(8px); overflow-y: auto; padding: 10px; align-items: center; justify-content: center; }
        .modal-content-wrapper { margin: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 1000px; outline: none; position: relative; }
        .close-btn-container { width: 100%; max-width: 800px; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .close-icon { color: white; font-size: 2rem; cursor: pointer; padding: 10px; border-radius: 50%; background: rgba(255,255,255,0.1); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .close-icon:hover { background: var(--matcha-leaf); transform: rotate(90deg); }
        .modal-layout { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: clamp(20px, 4vw, 60px); width: 100%; margin-bottom: 20px; }
        .modal-image-col { flex: 0 1 auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #modalPrizeImg { width: auto; max-width: 100%; height: auto; max-height: 250px; object-fit: contain; border-radius: 12px; border: 4px solid var(--gold-leaf); background: #fff; padding: 10px; box-shadow: 0 0 40px rgba(212, 175, 55, 0.4); }
        .modal-prize-title { color: white; font-family: 'Playfair Display'; font-size: 1.5rem; text-align: center; max-width: 300px; }
        .wheel-container { position: relative; width: 380px; height: 380px; flex-shrink: 0; }
        canvas { width: 100%; height: 100%; border-radius: 50%; border: 8px solid white; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 50px solid var(--gold-leaf); z-index: 10; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }
        .winner-announce { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 700; color: #FFD700; text-align: center; min-height: 80px; opacity: 0; transform: scale(0.8); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; margin-top: 10px; }
        .winner-announce.show { opacity: 1; transform: scale(1); text-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        .spin-btn { background: linear-gradient(135deg, #FFD700, #FDB931); color: #4A443F; padding: 18px 60px; font-size: 1.3rem; border-radius: 50px; border: none; cursor: pointer; font-weight: 800; letter-spacing: 3px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); margin-top: 10px; transition: 0.2s; }
        .spin-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }

        .footer-controls { margin: 60px 0 20px; opacity: 0.5; transition: 0.3s; text-align: center; }
        .footer-controls:hover { opacity: 1; }
        .reset-link { color: var(--alert-red); text-decoration: underline; cursor: pointer; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }

        @media (max-width: 900px) { .modal-layout { flex-direction: column; gap: 25px; } .wheel-container { width: 300px; height: 300px; } }
    </style>
</head>
<body>
    <nav>
        <div class="nav-links">
            <a href="index.html" class="nav-item">The Porch</a>
            <a href="#" class="nav-item active">Lucky Draw</a>
        </div>
    </nav>
    <header><h1>Valentine & Pre-CNY Draw</h1></header>

    <section class="setup-container" id="setupArea">
        <div class="input-group">
            <h3>üîµ Option A</h3>
            <small>Pot A (2 entries/person)</small>
            <textarea id="listA" placeholder="Paste names..."></textarea>
        </div>
        <div class="input-group">
            <h3>üü¢ Option B</h3>
            <small>Pot B (2 entries/person)</small>
            <textarea id="listB" placeholder="Paste names..."></textarea>
        </div>
        <div class="input-group">
            <h3>üü° Option C</h3>
            <small>ALL Pots (1 entry/person)</small>
            <textarea id="listC" placeholder="Paste names..."></textarea>
        </div>
        <div class="btn-row"><button class="lock-btn" onclick="lockLists()">Lock & Start Game</button></div>
    </section>

    <section class="participants-board" id="participantsBoard">
        <div class="p-column"><h4>üîµ Option A</h4><ul class="p-list" id="displayListA"></ul></div>
        <div class="p-column"><h4>üü¢ Option B</h4><ul class="p-list" id="displayListB"></ul></div>
        <div class="p-column"><h4>üü° Option C</h4><ul class="p-list" id="displayListC"></ul></div>
    </section>

    <main id="gameArea" style="opacity: 0.3; pointer-events: none;">
        <section class="game-section">
            <div class="pot-title"><span>Pot A Prizes</span><span class="pot-rules">Opt A (x2) + Opt C (x1)</span></div>
            <div class="prizes-grid">
                <div class="prize-card" id="card_maracaibo" onclick="openDraw('Option A', 'Maracaibo', this)"><img src="luckydraw/maracaibo.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Maracaibo'"><div class="card-overlay"><h4>Maracaibo</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_teagarden" onclick="openDraw('Option A', 'Tea Garden', this)"><img src="luckydraw/teagarden.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Tea+Garden'"><div class="card-overlay"><h4>Tea Garden</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_chipsA" onclick="openDraw('Option A', 'Bag of Chips', this)"><img src="luckydraw/bag.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Chips'"><div class="card-overlay"><h4>Bag of Chips</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_beacon" onclick="openDraw('Option A', 'Beacon Patrol', this)"><img src="luckydraw/beacon.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Beacon'"><div class="card-overlay"><h4>Beacon Patrol</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_coexist" onclick="openDraw('Option A', 'Coexist', this)"><img src="luckydraw/coexist.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Coexist'"><div class="card-overlay"><h4>Coexist</h4><div class="winner-display"></div></div></div>
            </div>
        </section>
        <section class="game-section">
            <div class="pot-title"><span>Pot B Prizes</span><span class="pot-rules">Opt B (x2) + Opt C (x1)</span></div>
            <div class="prizes-grid">
                <div class="prize-card" id="card_dbd" onclick="openDraw('Option B', 'Dead by Daylight', this)"><img src="luckydraw/deadbydaylight.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Dead+By+Daylight'"><div class="card-overlay"><h4>Dead by Daylight</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_potion" onclick="openDraw('Option B', 'Potion Explosion', this)"><img src="luckydraw/potion.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Potion+Explosion'"><div class="card-overlay"><h4>Potion Explosion</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_alma" onclick="openDraw('Option B', 'Alma Mater', this)"><img src="luckydraw/alma.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Alma+Mater'"><div class="card-overlay"><h4>Alma Mater</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_kanagawa" onclick="openDraw('Option B', 'Kanagawa', this)"><img src="luckydraw/kanagawa.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Kanagawa'"><div class="card-overlay"><h4>Kanagawa</h4><div class="winner-display"></div></div></div>
                <div class="prize-card" id="card_chipsB" onclick="openDraw('Option B', 'Bag of Chips', this)"><img src="luckydraw/bag.webp" class="game-img" onerror="this.src='https://placehold.co/400?text=Chips'"><div class="card-overlay"><h4>Bag of Chips</h4><div class="winner-display"></div></div></div>
            </div>
        </section>
        <div class="footer-controls"><span class="reset-link" onclick="factoryReset()">‚ö† Factory Reset (Clears All Data)</span></div>
    </main>

    <div id="wheelModal" class="modal">
        <div class="modal-content-wrapper">
            <div class="close-btn-container"><span class="close-icon" onclick="closeModal()">‚úï</span></div>
            <div class="modal-layout">
                <div class="modal-image-col"><img id="modalPrizeImg" src="" alt="Prize"><div id="modalPrizeName" class="modal-prize-title">Prize Name</div></div>
                <div class="wheel-container"><div class="pointer"></div><canvas id="wheelCanvas" width="760" height="760"></canvas></div>
            </div>
            <div id="winnerText" class="winner-announce"></div>
            <button id="spinBtn" class="spin-btn" onclick="spinWheel()">SPIN THE WHEEL</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTick() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }
        function playWinSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            [440, 554, 659, 880].forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine'; osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + 1.5);
                }, i * 100);
            });
        }

        function announceWinner(name) {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance();
                msg.text = `Congratulations to the winner, ${name}!`;
                msg.volume = 1;
                msg.rate = 0.85; // Slightly slower for a sultry/confident vibe
                msg.pitch = 1.2; // Slightly higher pitch

                // Look for the best female voice available on the device
                const voices = window.speechSynthesis.getVoices();
                const preferred = voices.find(v => 
                    v.name.includes('Samantha') || 
                    v.name.includes('Natural') || 
                    v.name.includes('Victoria') || 
                    (v.name.includes('Google') && v.name.includes('Female'))
                );
                
                if (preferred) msg.voice = preferred;
                window.speechSynthesis.speak(msg);
            }
        }
        // Pre-load voices for Chrome
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

        let namesA = [], namesB = [], namesC = [];
        let pastWinners = JSON.parse(localStorage.getItem('ara_winners') || '{}'); 
        let currentPool = [], currentCardId = null, currentCardEl = null, isSpinning = false;
        const canvas = document.getElementById('wheelCanvas'), ctx = canvas.getContext('2d');
        const wheelColors = ['#6B7A68', '#F2E8D5', '#8F9E8B', '#D4AF37', '#4A443F', '#A3BFA1'];

        window.onload = function() {
            if(localStorage.getItem('ara_names')) {
                const saved = JSON.parse(localStorage.getItem('ara_names'));
                document.getElementById('listA').value = saved.A;
                document.getElementById('listB').value = saved.B;
                document.getElementById('listC').value = saved.C;
                lockLists(false); 
            }
            updateGridFromStorage();
        }

        function updateGridFromStorage() {
            for (const [cardId, winnerName] of Object.entries(pastWinners)) {
                const el = document.getElementById(cardId);
                if(el) markAsDrawn(el, winnerName);
            }
        }

        function lockLists(showConfirm = true) {
            namesA = document.getElementById('listA').value.split('\n').map(n=>n.trim()).filter(n => n);
            namesB = document.getElementById('listB').value.split('\n').map(n=>n.trim()).filter(n => n);
            namesC = document.getElementById('listC').value.split('\n').map(n=>n.trim()).filter(n => n);
            if ([...namesA, ...namesB, ...namesC].length === 0 && showConfirm) return alert("Please enter names.");
            if(showConfirm && !confirm("Ready to start?")) return;

            localStorage.setItem('ara_names', JSON.stringify({A: document.getElementById('listA').value, B: document.getElementById('listB').value, C: document.getElementById('listC').value}));
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('participantsBoard').style.display = 'grid';
            document.getElementById('gameArea').style.opacity = '1';
            document.getElementById('gameArea').style.pointerEvents = 'auto';
            renderParticipants();
        }

        function renderParticipants() {
            const winners = Object.values(pastWinners);
            const createListHTML = (names) => names.map(n => `<li class="p-item ${winners.includes(n) ? 'won' : ''}">${n}</li>`).join('');
            document.getElementById('displayListA').innerHTML = createListHTML(namesA);
            document.getElementById('displayListB').innerHTML = createListHTML(namesB);
            document.getElementById('displayListC').innerHTML = createListHTML(namesC);
        }

        function openDraw(optionType, prizeName, el) {
            if(el.classList.contains('drawn')) return;
            currentCardEl = el; currentCardId = el.id;
            const usedNames = new Set(Object.values(pastWinners));
            currentPool = [];
            let mainList = (optionType === 'Option A') ? namesA : namesB;
            mainList.forEach(n => { if(!usedNames.has(n)) { currentPool.push(n); currentPool.push(n); } });
            namesC.forEach(n => { if(!usedNames.has(n)) { currentPool.push(n); } });
            currentPool.sort(() => Math.random() - 0.5);
            if(currentPool.length === 0) return alert("Everyone has won something!");

            document.getElementById('modalPrizeImg').src = el.querySelector('.game-img').src;
            document.getElementById('modalPrizeName').innerText = prizeName;
            document.getElementById('wheelModal').style.display = 'flex';
            document.getElementById('winnerText').classList.remove('show');
            document.getElementById('spinBtn').style.display = 'block';
            drawWheel(0);
        }

        function drawWheel(rotationOffset) {
            const num = currentPool.length, arc = (2 * Math.PI) / num, centerX = canvas.width / 2, centerY = canvas.height / 2, radius = centerX - 10;
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(centerX, centerY); ctx.rotate(rotationOffset);
            for(let i=0; i<num; i++){
                const angle = i * arc;
                ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.fillStyle = wheelColors[i % wheelColors.length]; ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
                ctx.save(); ctx.rotate(angle + arc/2); ctx.textAlign = "right";
                ctx.fillStyle = (i % wheelColors.length === 1 || i % wheelColors.length === 5) ? "#4A443F" : "#FFFFFF";
                ctx.font = "bold 24px Quicksand";
                let text = currentPool[i]; if(text.length > 14) text = text.substring(0,12) + "..";
                ctx.fillText(text, radius - 40, 10); ctx.restore();
            }
            ctx.restore();
        }

        function spinWheel() {
            if(isSpinning) return; isSpinning = true;
            document.getElementById('spinBtn').style.display = 'none';
            const winnerIdx = Math.floor(Math.random() * currentPool.length), winnerName = currentPool[winnerIdx];
            const arc = (2 * Math.PI) / currentPool.length, winnerAngle = (winnerIdx * arc) + (arc / 2);
            const fuzz = (Math.random() * arc * 0.8) - (arc * 0.4); 
            const targetRotation = (2 * Math.PI * 5) - winnerAngle - (Math.PI / 2) + fuzz;
            let start = null, lastTick = 0;

            function animate(time) {
                if(!start) start = time;
                const elapsed = time - start, progress = Math.min(elapsed / 5000, 1), ease = 1 - Math.pow(1 - progress, 4);
                drawWheel(ease * targetRotation);
                const speed = (1 - progress); 
                if(speed > 0.05 && (time - lastTick) > (100 + (1-speed)*400)) { playTick(); lastTick = time; }
                if(progress < 1) requestAnimationFrame(animate);
                else finishSpin(winnerName);
            }
            requestAnimationFrame(animate);
        }

        function finishSpin(winner) {
            isSpinning = false;
            playWinSound();
            announceWinner(winner); // Trigger the Voice

            const winText = document.getElementById('winnerText');
            winText.innerText = winner; winText.classList.add('show');
            
            // Grand Fireworks
            var duration = 3000, animationEnd = Date.now() + duration;
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                confetti({ particleCount: 50, spread: 360, origin: { x: Math.random(), y: Math.random() - 0.2 }, zIndex: 3000, colors: ['#D4AF37', '#6B7A68', '#FFF'] });
            }, 250);
            
            pastWinners[currentCardId] = winner;
            localStorage.setItem('ara_winners', JSON.stringify(pastWinners));
            if(currentCardEl) markAsDrawn(currentCardEl, winner);
            renderParticipants();
        }

        function markAsDrawn(el, name) { el.classList.add('drawn'); el.querySelector('.winner-display').innerText = "Won by " + name; }
        function closeModal() { if(!isSpinning) document.getElementById('wheelModal').style.display = 'none'; }
        function factoryReset() { if(confirm("Wipe everything?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>